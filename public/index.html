<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>
		<meta name="HandheldFriendly" content="True"/>
		<title>Dice Game Channels</title>

		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/min/1.5/min.min.css">
		<link rel="stylesheet" type="text/css" href="./styles.css">

		<!-- <script src="http://localhost:8888/static/js/bundle.js"></script> -->
		<!-- <script src="https://platform.dao.casino/api/lib/v2/DC.js?v=2"></script> -->

		<script> 			
			const GameLogic = function(){
				var balance = 0
				var history = []

				var setBalance = function(deposit){
					balance = deposit*1
				}

				var getBalance = function(){ 
					return balance 
				}

				var Roll = function(user_bet, user_num, random_hash){
					let profit = -user_bet
					
					const random_num = DCLib().Utils.bigInt(random_hash,16).divmod(65536).remainder.value
					
					if (user_num > random_num) {
						profit = (user_bet * (65536 - 1310) / user_num) - user_bet
					}
					if (user_num == random_num) {
						profit = user_bet
					}

					balance += profit*1

					const roll_item = {
						timestamp   : new Date().getTime(),
						user_bet    : user_bet,
						profit      : profit,
						user_num    : user_num,
						balance     : balance,
						random_hash : random_hash,
						random_num  : random_num,
					}

					history.push(roll_item)

					return roll_item
				}

				return {
					setBalance: setBalance,
					getBalance: getBalance,
					roll:       Roll,
					history:    history,
				}
			}



			document.addEventListener('DOMContentLoaded', function(){
			
				// Wait when DClib loaded
				DCLib.on('ready', function(){	
					
					// Create our DApp
					window.MyDApp = new DCLib.DApp({
						code  : 'dicegame_v2' , // unique DApp code
						logic : GameLogic     , // inject logic constructor in your DApp
					})
					
					// console.log(MyDApp)
				})

				// Init interface
				initView({
					// Create DApp and open payment channel
					onSetDeposit : startGame,
				
					// call DApp functions, and send res to bankroller 
					onPlay       : callDAppFunc,
				
					// close payment channel, destroy DApp
					onEndGame    : endGame,
				})
			})
			

	


			function startGame(deposit){

				MyDApp.connect({
						bankroller : 'auto', // or bankroller address	
						
						// paychannel:{
						// 	deposit : deposit,

						// 	contract: {
						// 		address: '0x...',
						// 		abi: {}
						// 	}
						// }
					},

					// open result
					function(result){
						console.log('openGamechannel res:', result)

						// set player balance in our game logic
						MyDApp.call('setBalance', [deposit], function(result){
							
						})


						document.getElementById('user_bet').max   = Math.ceil(deposit/100000000)
						document.getElementById('user_bet').value = 1

						document.body.classList.add('cur-step-2')
						document.body.classList.add('cur-step-3')
					}
				)
			}

			function callDAppFunc(){}
			function endGame(){}


			

			
			function initView(callbacks){
				const updBalance = function(){
					document.getElementById('user_balance').innerText = '...'
					
					DCLib.Account.info(function(info){
						document.getElementById('user_balance').innerText = info.balance.bet
						
						setTimeout(updBalance, 7000)

						if (info.balance.bet > 0) {
							document.body.classList.add('cur-step-1')
						}
					})
				}
				updBalance()


				document.body.classList.add('cur-step-1')
				document.getElementById('loading').style.display = 'none'
				document.getElementById('content').style.display = 'block'

				document.getElementById('user_address').innerHTML = '<a target="_blank" href="https://ropsten.etherscan.io/address/'+DCLib.Account.get().openkey+'">'+DCLib.Account.get().openkey+'</a>'
				document.getElementById('faucet').href = 'https://platform.dao.casino/faucet?to='+DCLib.Account.get().openkey

				document.querySelector('.step-1 form').addEventListener('submit', function(e){
					e.preventDefault()

					e.target.classList.add('disabled')

					var deposit = document.getElementById('user_deposit').value*100000000
					
					callbacks.onSetDeposit( deposit )					
				})



				document.querySelector('form.step-2').addEventListener('submit', function(e){
					e.preventDefault()
					var form = e.target
					form.classList.add('disabled')

					var user_bet = document.getElementById('user_bet').value
					var user_num = document.getElementById('user_num').value

					callbacks.onRoll()

					MyDApp.callChannelGameFunc(
						// function name and args
						'roll', [user_bet*100000000, user_num, MyDApp.getChannelGameRandom()],

						// result
						function(res){
							window.Game.roll(user_bet*100000000, user_num, res.random_hash)
							
							renderGames()

							var ubets = Game.balance()/100000000
							document.getElementById('user_bet').max = ubets

							if (ubets > 0.00005) {
								form.classList.remove('disabled')
							}
						},

						// log
						function(log){
							var d = document.createElement('div')
								d.innerHTML = ' >> '+log
							document.getElementById('play_log').appendChild(d)
						}
					)
				})

				document.querySelector('form.step-3').addEventListener('submit', function(e){
					e.preventDefault()

					callbacks.onEndGame()
					MyDApp.closeGameChannel(Game.balance(), function(result){
						console.log('result',result)
					})
				})
			}


			function renderGames(history){
				if (typeof Game === 'undefined') {
					window.Game = { balance: 11 }
				}

				history = history || Game.history
				var ghtml = ''
				for(var k in history){
					var g = history[k]
					ghtml += '<tr><td>'+g.user_bet+'</td><td>'+g.user_num+'</td><td><span class="hash">'+g.random_hash+'</span></td><td>'+g.random_num+'</td><td>'+g.profit+'</td></tr>'
				}

				ghtml = '<table><thead><tr><th>bet</th><th>num</th><th>hash</th><th>random</th><th>profit</th></tr></thead><tbody>'+ghtml+'</tbody><tfoot><tr><th colspan="5">Game Balance: '+Game.balance()+'</th></tr></tfoot></table>'

				document.getElementById('games_list').innerHTML = ghtml
			}
		</script>
	</head>
	<body class="cur-step-0">

		<p id="loading">Loading...</p>

		<section id="content" style="display: none">

			<div id="user" class="step step-0">
				<h3>0. Create account, get BETs</h3>
				<p>
					<b>addr</b>: &nbsp;<span id="user_address"></span>
					<br>
					<br>
					<b>BET</b>: &nbsp;<span id="user_balance"></span>
					&nbsp;
					<a id="faucet" target="_blank" href="">faucet</a>
				</p>
			</div>

			<div class="step step-1">
				<h3>1. Open game-channel</h3>

				<form>
					<label>
						Set game deposit:
						<input id="user_deposit" type="number" value="2" min="0" max="4" step="0.1">
					</label>
					<input type="submit" value="Set">
				</form>

				<div id="open_log">

				</div>
			</div>

			<form class="step step-2">
				<h3>2. Play</h3>
				<label>
					your bet:
					<input id="user_bet" type="number" value="1" min="0" max="4" step="0.1">
				</label>
				<label>
					your num:
					<input id="user_num" type="number" value="35000" min="0" max="65000" step="1">
				</label>

				<input type="submit" value="Roll">

				<div id="play_log"></div>
				<div id="games_list"></div>
			</form>

			<form class="step step-3">
				<h3>3. Close game-channel</h3>

				<div id="close_info"></div>
				<input type="submit" value="Close">

				<div id="close_log"></div>
			</form>


		</section>
	</body>
</html>
